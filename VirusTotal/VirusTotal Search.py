# VirusTotal automated search script 1.0
import requests
import json
import time
#Specify the path of the file containing a list of file hashes to be examined
listfile = 'E:/22S1/Applied Project/Malware analysis file/VirusTotal/list.txt'
#Specify the path of the file in which the search results are saved
resultfile = 'E:/22S1/Applied Project/Malware analysis file/VirusTotal/result.txt'

#Read in the hashes, range(0,n) means there are n hashes to be searched
handle = open(listfile, 'r')
hashlist = []
for i in range(0,125):
    hashlist.append(handle.readline().rstrip('\n'))
handle.close

#define search header and inlucde apikey (unique for every VirusTotal user)
headers = {
    "Accept": "application/json",
    "x-apikey": "1247fd86554f349dc44e8a871cf91698349267789e2ffde8ee3641b5a434b4ba"
}
url = "https://www.virustotal.com/api/v3/search?query="

#Search
for filehash in hashlist:
    searchUrl = url + filehash
    print('searching: '+searchUrl+'\n')
    response = requests.get(searchUrl, headers=headers)
    #response.test is the response in JSON format, convert JSON to python dictionary format
    pyresult=json.loads(response.text)
    #write to file (append mode)
    handle = open(resultfile, 'a')
    #specify the information to be saved, where the saved information can be customized
    handle.write(filehash + '\t' + str(pyresult['data'][0]['attributes']['type_description']))
    if('packers' in pyresult['data'][0]['attributes']):
        handle.write('\t' + str(pyresult['data'][0]['attributes']['packers']))
    if('names' in pyresult['data'][0]):
        handle.write('\t' + str(pyresult['data'][0]['names']))
    handle.write('\n')
    handle.close
    #initiate a new search after 16 seconds, since public API only allows 4 search attempts per minute
    time.sleep(16)